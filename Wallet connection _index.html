<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Chain Wallet Connector</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font for a modern look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        /* Custom modal styles for better user experience than default alert() */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top of everything */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if content is too big */
            background-color: rgba(0,0,0,0.4); /* Black background with opacity */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            backdrop-filter: blur(5px); /* Add a blur effect to the background */
        }
        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 12px; /* Rounded corners */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); /* Stronger shadow */
            width: 90%;
            max-width: 450px; /* Max width for larger screens */
            text-align: center;
            position: relative;
            animation: fadeIn 0.3s ease-out; /* Simple fade-in animation */
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
        }

        /* Keyframe animation for modal */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center border border-gray-200">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6">Wallet Connection Options üåê</h1>

        <!-- Toggle Buttons for Connect Options -->
        <div class="flex justify-center gap-2 md:gap-4 mb-6 flex-wrap">
            <button id="show-mobile-connect-btn" class="px-4 py-2 md:px-6 md:py-3 rounded-xl bg-blue-600 text-white font-semibold shadow-md transition duration-300 hover:bg-blue-700 text-sm md:text-base">
                Mobile Wallet
            </button>
            <button id="show-browser-connect-btn" class="px-4 py-2 md:px-6 md:py-3 rounded-xl bg-gray-200 text-gray-800 font-semibold shadow-md transition duration-300 hover:bg-gray-300 text-sm md:text-base">
                Browser Wallet
            </button>
            <button id="show-manual-connect-btn" class="px-4 py-2 md:px-6 md:py-3 rounded-xl bg-gray-200 text-gray-800 font-semibold shadow-md transition duration-300 hover:bg-gray-300 text-sm md:text-base">
                Manual Connect
            </button>
        </div>

        <hr class="my-6 border-gray-200">

        <!-- Mobile Wallet Connect Section (WalletConnect) -->
        <div id="mobile-connect-section" class="flex flex-col items-center">
            <div id="mobile-connect-status" class="mb-6 text-lg text-gray-600">
                Connect your mobile wallet via WalletConnect.
            </div>

            <button id="connect-mobile-button"
                    class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg
                           transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-300
                           w-full flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M3 8a2 2 0 012-2h10a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5-3a1 1 0 00-1 1v2a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                Connect Mobile Wallet
            </button>

            <div id="mobile-connected-info" class="mt-8 p-4 bg-gray-50 border border-gray-200 rounded-xl hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Wallet Connected! üéâ</h2>
                <p class="text-gray-600 break-all mb-2">
                    <span class="font-medium">Address:</span> <span id="mobile-wallet-address" class="text-purple-600 font-mono"></span>
                </p>
                <p class="text-gray-600 break-all">
                    <span class="font-medium">Network:</span> <span id="mobile-wallet-network" class="text-purple-600"></span> (Chain ID: <span id="mobile-wallet-chainid" class="text-purple-600"></span>)
                </p>
                <button id="switch-network-mobile-button" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Switch Network
                </button>
                <button id="disconnect-mobile-button"
                        class="mt-4 ml-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Disconnect
                </button>
            </div>

            <!-- Loading Indicator for Mobile Connect -->
            <div id="mobile-loading-spinner" class="mt-8 hidden flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                <p class="ml-3 text-gray-600">Connecting...</p>
            </div>
        </div>

        <!-- Browser Wallet Connect Section (e.g., MetaMask) -->
        <div id="browser-connect-section" class="hidden flex flex-col items-center">
            <div id="browser-connect-status" class="mb-6 text-lg text-gray-600">
                Connect your **primary** browser-based wallet (e.g., MetaMask, Brave Wallet, Coinbase Wallet). You can switch accounts/networks within your connected wallet.
            </div>

            <button id="connect-browser-button"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg
                           transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300
                           w-full flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M3 8a2 2 0 012-2h10a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5-3a1 1 0 00-1 1v2a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                Connect Browser Wallet
            </button>

            <div id="browser-connected-info" class="mt-8 p-4 bg-gray-50 border border-gray-200 rounded-xl hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Wallet Connected! üéâ</h2>
                <p class="text-gray-600 break-all mb-2">
                    <span class="font-medium">Address:</span> <span id="browser-wallet-address" class="text-blue-600 font-mono"></span>
                </p>
                <p class="text-gray-600 break-all">
                    <span class="font-medium">Network:</span> <span id="browser-wallet-network" class="text-blue-600"></span> (Chain ID: <span id="browser-wallet-chainid" class="text-blue-600"></span>)
                </p>
                <button id="switch-network-browser-button" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Switch Network
                </button>
                <button id="disconnect-browser-button"
                        class="mt-4 ml-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Disconnect
                </button>
            </div>

            <!-- Loading Indicator for Browser Connect -->
            <div id="browser-loading-spinner" class="mt-8 hidden flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="ml-3 text-gray-600">Connecting...</p>
            </div>
        </div>

        <!-- Manual Connect Section -->
        <div id="manual-connect-section" class="hidden flex flex-col items-center mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Manual Wallet Connection</h2>
            <p id="manual-connect-note" class="text-sm text-red-600 mb-4 text-center p-2 bg-red-50 rounded-lg border border-red-200 hidden">
                Note: Manual connection is primarily for **viewing balances** and does not enable transactions or signing messages.
                It relies on public APIs which may have rate limits or require API keys for production use.
            </p>

            <div class="w-full max-w-sm mb-4">
                <label for="network-select" class="block text-left text-gray-700 text-sm font-bold mb-2">Select Network:</label>
                <select id="network-select"
                        class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight
                               focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-blue-300 bg-white">
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>

            <div id="address-input-container" class="w-full max-w-sm hidden mb-4">
                <label for="wallet-address-input" class="block text-left text-gray-700 text-sm font-bold mb-2">Enter Address:</label>
                <input type="text" id="wallet-address-input" placeholder="e.g., 0x..."
                       class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight
                              focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-blue-300">
            </div>

            <button id="fetch-balance-button"
                    class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg
                           transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300
                           w-full max-w-sm flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                </svg>
                Fetch Balance
            </button>

            <div id="manual-connection-info" class="mt-8 p-4 bg-gray-50 border border-gray-200 rounded-xl hidden w-full max-w-sm text-left">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Manual Connection Details:</h2>
                <p class="text-gray-600 break-all mb-2">
                    <span class="font-medium">Network:</span> <span id="manual-network-display" class="text-blue-600"></span>
                </p>
                <p class="text-gray-600 break-all mb-2">
                    <span class="font-medium">Address:</span> <span id="manual-address-display" class="text-blue-600 font-mono"></span>
                </p>
                <p class="text-gray-600 break-all">
                    <span class="font-medium">Balance:</span> <span id="manual-balance-display" class="text-blue-600 font-mono"></span>
                </p>
                <button id="view-wallet-button" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out hidden">
                    View Wallet on Explorer
                </button>
            </div>

            <!-- Loading Indicator for Manual Connect -->
            <div id="manual-loading-spinner" class="mt-8 hidden flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
                <p class="ml-3 text-gray-600">Connecting...</p>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Messages (replaces alert() for better UX) -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-modal-button">&times;</span>
            <p id="modal-message" class="text-lg text-gray-800"></p>
        </div>
    </div>

    <!-- Network Switch Modal -->
    <div id="network-switch-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-network-switch-modal-button">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Switch Network</h2>
            <p class="text-gray-600 mb-4">Select a network to switch to in your wallet.</p>
            <select id="network-switch-select"
                    class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight
                           focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-blue-300 bg-white mb-4">
                <!-- Options will be populated by JavaScript -->
            </select>
            <button id="confirm-network-switch-button"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                Switch
            </button>
        </div>
    </div>

    <!-- External JavaScript Libraries for WalletConnect and Web3 functionalities -->
    <!-- WalletConnect v1 and Web3.js are used for broader browser compatibility in a single HTML file -->
    <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>

    <script>
        // --- DOM Element References ---
        const showMobileConnectBtn = document.getElementById('show-mobile-connect-btn');
        const showBrowserConnectBtn = document.getElementById('show-browser-connect-btn');
        const showManualConnectBtn = document.getElementById('show-manual-connect-btn');

        const mobileConnectSection = document.getElementById('mobile-connect-section');
        const browserConnectSection = document.getElementById('browser-connect-section');
        const manualConnectSection = document.getElementById('manual-connect-section');

        // Mobile Connect Elements (WalletConnect)
        const connectMobileButton = document.getElementById('connect-mobile-button');
        const disconnectMobileButton = document.getElementById('disconnect-mobile-button');
        const mobileConnectStatus = document.getElementById('mobile-connect-status');
        const mobileConnectedInfo = document.getElementById('mobile-connected-info');
        const mobileWalletAddressSpan = document.getElementById('mobile-wallet-address');
        const mobileWalletNetworkSpan = document.getElementById('mobile-wallet-network');
        const mobileWalletChainIdSpan = document.getElementById('mobile-wallet-chainid');
        const mobileLoadingSpinner = document.getElementById('mobile-loading-spinner');
        const switchNetworkMobileButton = document.getElementById('switch-network-mobile-button'); // New switch button

        // Browser Connect Elements (e.g., MetaMask)
        const connectBrowserButton = document.getElementById('connect-browser-button');
        const disconnectBrowserButton = document.getElementById('disconnect-browser-button');
        const browserConnectStatus = document.getElementById('browser-connect-status');
        const browserConnectedInfo = document.getElementById('browser-connected-info');
        const browserWalletAddressSpan = document.getElementById('browser-wallet-address');
        const browserWalletNetworkSpan = document.getElementById('browser-wallet-network');
        const browserWalletChainIdSpan = document.getElementById('browser-wallet-chainid');
        const browserLoadingSpinner = document.getElementById('browser-loading-spinner');
        const switchNetworkBrowserButton = document.getElementById('switch-network-browser-button'); // New switch button

        // Manual Connect Elements
        const manualConnectNote = document.getElementById('manual-connect-note');
        const networkSelect = document.getElementById('network-select');
        const addressInputContainer = document.getElementById('address-input-container');
        const walletAddressInput = document.getElementById('wallet-address-input');
        const fetchBalanceButton = document.getElementById('fetch-balance-button');
        const manualConnectionInfo = document.getElementById('manual-connection-info');
        const manualNetworkDisplay = document.getElementById('manual-network-display');
        const manualAddressDisplay = document.getElementById('manual-address-display');
        const manualBalanceDisplay = document.getElementById('manual-balance-display');
        const manualLoadingSpinner = document.getElementById('manual-loading-spinner');
        const viewWalletButton = document.getElementById('view-wallet-button');

        // Modals
        const messageModal = document.getElementById('message-modal');
        const modalMessage = document.getElementById('modal-message');
        const closeModalButton = document.getElementById('close-modal-button');

        const networkSwitchModal = document.getElementById('network-switch-modal');
        const networkSwitchSelect = document.getElementById('network-switch-select');
        const closeNetworkSwitchModalButton = document.getElementById('close-network-switch-modal-button');
        const confirmNetworkSwitchButton = document.getElementById('confirm-network-switch-button');

        // Global Web3 instances for active connections
        let web3MobileProvider = null; // For WalletConnect v1 provider
        let web3Browser = null; // For window.ethereum provider
        let currentWalletType = null; // To track which wallet is active for network switching

        // --- Utility Functions for Custom Modal ---
        function showModal(message) {
            modalMessage.textContent = message;
            messageModal.style.display = 'flex';
        }

        function hideModal() {
            modalMessage.textContent = ''; // Clear message when hiding
            messageModal.style.display = 'none';
        }

        closeModalButton.onclick = hideModal;
        window.onclick = function(event) {
            if (event.target === messageModal) {
                hideModal();
            }
        };

        function showNetworkSwitchModal(walletType) {
            currentWalletType = walletType;
            networkSwitchSelect.innerHTML = '<option value="">Select a Network</option>';
            networks.filter(net => net.type === 'evm').forEach(network => { // Only show EVM chains for switching
                const option = document.createElement('option');
                option.value = network.id;
                option.textContent = network.name;
                networkSwitchSelect.appendChild(option);
            });
            networkSwitchModal.style.display = 'flex';
        }

        function hideNetworkSwitchModal() {
            networkSwitchModal.style.display = 'none';
            currentWalletType = null;
        }

        closeNetworkSwitchModalButton.onclick = hideNetworkSwitchModal;
        window.onclick = function(event) {
            if (event.target === networkSwitchModal) {
                hideNetworkSwitchModal();
            }
        };

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // --- Network Configurations ---
        const networks = [
            // EVM Networks
            { id: 'eth_mainnet', name: 'Ethereum Mainnet', type: 'evm', chainId: '0x1', symbol: 'ETH', rpc: `https://mainnet.infura.io/v3/${'c35d1ef971da479b918c9900134867d4'}`, explorerUrl: 'https://etherscan.io/address/' },
            { id: 'eth_ropsten', name: 'Ropsten Testnet', type: 'evm', chainId: '0x3', symbol: 'ETH', rpc: `https://ropsten.infura.io/v3/${'c35d1ef971da479b918c9900134867d4'}`, explorerUrl: 'https://ropsten.etherscan.io/address/' },
            { id: 'eth_rinkeby', name: 'Rinkeby Testnet', type: 'evm', chainId: '0x4', symbol: 'ETH', rpc: `https://rinkeby.infura.io/v3/${'c35d1ef971da479b918c9900134867d4'}`, explorerUrl: 'https://rinkeby.etherscan.io/address/' },
            { id: 'eth_goerli', name: 'Goerli Testnet', type: 'evm', chainId: '0x5', symbol: 'ETH', rpc: `https://goerli.infura.io/v3/${'c35d1ef971da479b918c9900134867d4'}`, explorerUrl: 'https://goerli.etherscan.io/address/' },
            { id: 'bsc_mainnet', name: 'BNB Smart Chain', type: 'evm', chainId: '0x38', symbol: 'BNB', rpc: `https://rpc.ankr.com/bsc/${'0338f3b98ad211aef5de661cba3f0ead0981460048cfabeee506cdd58a298204'}`, explorerUrl: 'https://bscscan.com/address/' },
            { id: 'polygon_mainnet', name: 'Polygon Mainnet', type: 'evm', chainId: '0x89', symbol: 'MATIC', rpc: 'https://polygon-rpc.com/', explorerUrl: 'https://polygonscan.com/address/' },
            { id: 'avax_c_chain', name: 'Avalanche C-Chain', type: 'evm', chainId: '0xA86A', symbol: 'AVAX', rpc: 'https://api.avax.network/ext/bc/C/rpc', explorerUrl: 'https://snowtrace.io/address/' },
            { id: 'arbitrum_one', name: 'Arbitrum One', type: 'evm', chainId: '0xA4B1', symbol: 'ETH', rpc: 'https://arb1.arbitrum.io/rpc', explorerUrl: 'https://arbiscan.io/address/' },
            { id: 'optimism_mainnet', name: 'Optimism Mainnet', type: 'evm', chainId: '0xA', symbol: 'ETH', rpc: 'https://mainnet.optimism.io', explorerUrl: 'https://optimistic.etherscan.io/address/' },
            { id: 'fantom_mainnet', name: 'Fantom Opera', type: 'evm', chainId: '0xfa', symbol: 'FTM', rpc: 'https://rpc.ftm.tools/', explorerUrl: 'https://ftmscan.com/address/' },
            // Non-EVM chains (Manual Connect Only for now)
            { id: 'btc', name: 'Bitcoin (BTC)', type: 'non-evm', symbol: 'BTC', api: 'https://api.blockcypher.com/v1/btc/main/addrs/', explorerUrl: 'https://blockchair.com/bitcoin/address/' },
            { id: 'tron', name: 'TRON (TRX)', type: 'non-evm', symbol: 'TRX', api: 'https://api.trongrid.io/wallet/getaccount', explorerUrl: 'https://tronscan.org/#/address/' },
            { id: 'solana', name: 'Solana (SOL)', type: 'non-evm', symbol: 'SOL', rpc: 'https://api.mainnet-beta.solana.com', explorerUrl: 'https://solscan.io/address/' },
            { id: 'polkadot', name: 'Polkadot (DOT)', type: 'non-evm', symbol: 'DOT', api: 'N/A', explorerUrl: 'https://polkadot.subscan.io/account/' },
            { id: 'cardano', name: 'Cardano (ADA)', type: 'non-evm', symbol: 'ADA', api: 'N/A', explorerUrl: 'https://explorer.cardano.org/en/address/' },
        ];

        // --- Populate Network Dropdown ---
        // Moved inside DOMContentLoaded for guaranteed definition before call
        function populateNetworks() {
            networkSelect.innerHTML = '<option value="">Select a Network</option>';
            networks.forEach(network => {
                const option = document.createElement('option');
                option.value = network.id;
                option.textContent = network.name;
                networkSelect.appendChild(option);
            });
        }

        // --- Section Visibility Toggles ---
        function showSection(sectionId) {
            const sections = {
                'mobile': mobileConnectSection,
                'browser': browserConnectSection,
                'manual': manualConnectSection
            };
            const buttons = {
                'mobile': showMobileConnectBtn,
                'browser': showBrowserConnectBtn,
                'manual': showManualConnectBtn
            };

            for (const key in sections) {
                if (key === sectionId) {
                    sections[key].classList.remove('hidden');
                    buttons[key].classList.remove('bg-gray-200', 'text-gray-800');
                    buttons[key].classList.add('bg-blue-600', 'text-white');
                    // Special handling for manual connect section elements
                    if (key === 'manual') {
                        addressInputContainer.classList.remove('hidden');
                        fetchBalanceButton.classList.remove('hidden');
                        manualConnectNote.classList.remove('hidden'); // Show the note when manual section is active
                    }
                } else {
                    sections[key].classList.add('hidden');
                    buttons[key].classList.remove('bg-blue-600', 'text-white');
                    buttons[key].classList.add('bg-gray-200', 'text-gray-800');
                    // Special handling for manual connect section elements
                    if (key === 'manual') {
                        addressInputContainer.classList.add('hidden');
                        fetchBalanceButton.classList.add('hidden');
                        manualConnectNote.classList.add('hidden'); // Hide the note when manual section is not active
                    }
                }
            }

            // Reset UI states for other sections when switching
            if (sectionId !== 'mobile') resetMobileConnectUI();
            if (sectionId !== 'browser') resetBrowserConnectUI();
            if (sectionId !== 'manual') resetManualConnectUI();
        }

        // --- Mobile Wallet Connect Logic (WalletConnect v1) ---
        async function updateMobileNetworkInfo(chainId) {
            const connectedChainId = parseInt(chainId, 16);
            const network = networks.find(n => n.type === 'evm' && parseInt(n.chainId, 16) === connectedChainId);
            if (network) {
                mobileWalletNetworkSpan.textContent = network.name;
                mobileWalletChainIdSpan.textContent = connectedChainId;
            } else {
                mobileWalletNetworkSpan.textContent = 'Unknown Network';
                mobileWalletChainIdSpan.textContent = connectedChainId;
            }
        }

        async function connectMobileWallet() {
            mobileLoadingSpinner.classList.remove('hidden');
            connectMobileButton.disabled = true;
            mobileConnectStatus.textContent = 'Opening WalletConnect modal...';

            try {
                if (typeof WalletConnectProvider === 'undefined' || !WalletConnectProvider.default) {
                    showModal("WalletConnect library not loaded. Please check your internet connection.");
                    return;
                }

                web3MobileProvider = new WalletConnectProvider.default({
                    projectId: "cedd3cec8430b2990ce3fe466ecb1a29", // Your WalletConnect Project ID
                    infuraId: "c35d1ef971da479b918c9900134867d4", // Your Infura ID
                    qrcode: true,
                    pollingInterval: 15000
                });

                web3MobileProvider.on("accountsChanged", (accounts) => {
                    console.log("Mobile accounts changed:", accounts);
                    if (accounts.length > 0) {
                        mobileWalletAddressSpan.textContent = accounts[0];
                        showModal(`Mobile wallet account changed to: ${accounts[0]}`);
                    } else {
                        disconnectMobileWallet();
                    }
                });

                web3MobileProvider.on("chainChanged", (chainId) => {
                    console.log("Mobile chain changed:", chainId);
                    updateMobileNetworkInfo(chainId);
                    showModal(`Mobile wallet network changed to Chain ID: ${parseInt(chainId, 16)}`);
                });

                web3MobileProvider.on("disconnect", (code, reason) => {
                    console.log("Mobile WalletConnect Disconnected:", code, reason);
                    disconnectMobileWallet();
                    showModal(`Mobile wallet disconnected. Reason: ${reason || 'Unknown'}`);
                });

                await web3MobileProvider.enable();
                const web3 = new Web3(web3MobileProvider);
                const accounts = await web3.eth.getAccounts();
                const chainId = await web3.eth.getChainId(); // Get current chain ID

                if (accounts.length > 0) {
                    const connectedAccount = accounts[0];
                    mobileConnectStatus.textContent = `Wallet Connected!`;
                    mobileWalletAddressSpan.textContent = connectedAccount;
                    mobileConnectedInfo.classList.remove('hidden');
                    connectMobileButton.classList.add('hidden');
                    disconnectMobileButton.classList.remove('hidden');
                    updateMobileNetworkInfo(chainId); // Update network info on connect
                    showModal(`Successfully connected mobile wallet: ${connectedAccount}`);
                } else {
                    showModal("No accounts found from mobile wallet. Please try connecting again.");
                    resetMobileConnectUI();
                }

            } catch (error) {
                console.error("Mobile wallet connection failed:", error);
                let errorMessage = "An unknown error occurred during mobile wallet connection.";
                if (error.message && error.message.includes("User closed modal")) {
                    errorMessage = "WalletConnect modal was closed. Please try again to connect.";
                } else if (error.message) {
                    errorMessage = error.message;
                } else if (error.code) {
                    errorMessage = `Error Code: ${error.code}`;
                }
                showModal(`Connection Error: ${errorMessage}`);
                resetMobileConnectUI();
            } finally {
                mobileLoadingSpinner.classList.add('hidden');
                connectMobileButton.disabled = false;
            }
        }

        async function disconnectMobileWallet() {
            if (web3MobileProvider && web3MobileProvider.connected) {
                try {
                    await web3MobileProvider.disconnect();
                } catch (error) {
                    console.error("Error during WalletConnect disconnect:", error);
                }
            }
            resetMobileConnectUI();
            showModal('Mobile wallet disconnected successfully.');
        }

        function resetMobileConnectUI() {
            if (web3MobileProvider && web3MobileProvider.removeListener) {
                // It's crucial to remove specific listener functions, not anonymous ones.
                // For simplicity in this demo, if anonymous functions were used for .on(),
                // we'd need to re-think or accept that old listeners might persist if not explicitly tracked.
                // However, WalletConnectProvider's on() typically creates internal event maps
                // that are cleared by .disconnect(), making explicit removeListener less critical
                // for standard cleanup. But good practice dictates proper removal.
            }
            web3MobileProvider = null;
            mobileConnectStatus.textContent = 'Connect your mobile wallet via WalletConnect.';
            mobileWalletAddressSpan.textContent = '';
            mobileWalletNetworkSpan.textContent = '';
            mobileWalletChainIdSpan.textContent = '';
            mobileConnectedInfo.classList.add('hidden');
            connectMobileButton.classList.remove('hidden');
            disconnectMobileButton.classList.add('hidden');
        }

        // --- Browser Wallet Connect Logic (e.g., MetaMask) ---
        async function updateBrowserNetworkInfo(chainId) {
            const connectedChainId = parseInt(chainId, 16);
            const network = networks.find(n => n.type === 'evm' && parseInt(n.chainId, 16) === connectedChainId);
            if (network) {
                browserWalletNetworkSpan.textContent = network.name;
                browserWalletChainIdSpan.textContent = connectedChainId;
            } else {
                browserWalletNetworkSpan.textContent = 'Unknown Network';
                browserWalletChainIdSpan.textContent = connectedChainId;
            }
        }

        async function connectBrowserWallet() {
            if (typeof window.ethereum === 'undefined') {
                showModal("MetaMask or other Ethereum browser wallet not detected. Please install one.");
                return;
            }

            browserLoadingSpinner.classList.remove('hidden');
            connectBrowserButton.disabled = true;
            browserConnectStatus.textContent = 'Requesting connection...';

            try {
                web3Browser = new Web3(window.ethereum);

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const chainId = await window.ethereum.request({ method: 'eth_chainId' }); // Get current chain ID

                if (accounts.length > 0) {
                    const connectedAccount = accounts[0];
                    browserConnectStatus.textContent = 'Wallet Connected!';
                    browserWalletAddressSpan.textContent = connectedAccount;
                    browserConnectedInfo.classList.remove('hidden');
                    connectBrowserButton.classList.add('hidden');
                    disconnectBrowserButton.classList.remove('hidden');
                    updateBrowserNetworkInfo(chainId); // Update network info on connect

                    // Confirmation for Browser Wallet
                    showModal(`Successfully connected browser wallet: ${connectedAccount}`);

                    // Remove existing listeners to prevent multiple bindings
                    if (window.ethereum.removeListener) {
                        window.ethereum.removeListener('accountsChanged', handleBrowserAccountsChanged);
                        window.ethereum.removeListener('chainChanged', handleBrowserChainChanged);
                    }
                    // Add new event listeners for MetaMask events
                    window.ethereum.on('accountsChanged', handleBrowserAccountsChanged);
                    window.ethereum.on('chainChanged', handleBrowserChainChanged);

                } else {
                    showModal("No accounts found. Please try connecting again.");
                    resetBrowserConnectUI();
                }
            } catch (error) {
                console.error("Browser wallet connection failed:", error);
                let errorMessage = "Connection failed. Please ensure your wallet is unlocked and try again.";
                if (error.code === 4001) {
                    errorMessage = "Connection rejected by user.";
                } else if (error.message) {
                    errorMessage = error.message;
                }
                showModal(`Connection Error: ${errorMessage}`);
                resetBrowserConnectUI();
            } finally {
                browserLoadingSpinner.classList.add('hidden');
                connectBrowserButton.disabled = false;
            }
        }

        async function disconnectBrowserWallet() {
            // MetaMask does not have a formal `disconnect` method for dApps.
            // Disconnecting usually means clearing the dApp's reference and resetting UI.
            // Users control connection from their wallet extension.
            showModal("You have disconnected from the dApp. To fully disconnect, please do so from your browser wallet extension.");
            resetBrowserConnectUI();
        }

        function resetBrowserConnectUI() {
            browserConnectStatus.textContent = 'Connect your browser-based wallet (e.g., MetaMask).';
            browserWalletAddressSpan.textContent = '';
            browserWalletNetworkSpan.textContent = '';
            browserWalletChainIdSpan.textContent = '';
            browserConnectedInfo.classList.add('hidden');
            connectBrowserButton.classList.remove('hidden');
            disconnectBrowserButton.classList.add('hidden');
            if (window.ethereum && window.ethereum.removeListener) {
                window.ethereum.removeListener('accountsChanged', handleBrowserAccountsChanged);
                window.ethereum.removeListener('chainChanged', handleBrowserChainChanged);
            }
            web3Browser = null;
        }

        // Event handlers for Browser Wallet events
        function handleBrowserAccountsChanged(accounts) {
            console.log("Browser wallet accounts changed:", accounts);
            if (accounts.length > 0) {
                browserWalletAddressSpan.textContent = accounts[0];
                showModal(`Browser wallet account changed to: ${accounts[0]}`);
            } else {
                showModal("Browser wallet disconnected from dApp.");
                resetBrowserConnectUI();
            }
        }

        function handleBrowserChainChanged(chainId) {
            console.log("Browser wallet chain changed:", chainId);
            updateBrowserNetworkInfo(chainId);
            showModal(`Browser wallet network changed to Chain ID: ${parseInt(chainId, 16)}`);
        }

        // --- Network Switching Logic ---
        confirmNetworkSwitchButton.addEventListener('click', async () => {
            const selectedNetworkId = networkSwitchSelect.value;
            if (!selectedNetworkId) {
                showModal('Please select a network to switch to.');
                return;
            }

            const targetNetwork = networks.find(n => n.id === selectedNetworkId && n.type === 'evm');
            if (!targetNetwork) {
                showModal('Invalid or unsupported network for switching.');
                return;
            }

            hideNetworkSwitchModal(); // Close the network selection modal

            try {
                if (currentWalletType === 'mobile' && web3MobileProvider) {
                    // For WalletConnect v1, we attempt to switch network using eth_request method.
                    // Note: WC v1's switch chain support is less direct than v2 or window.ethereum.
                    // It often relies on the mobile wallet app to handle the request.
                    await web3MobileProvider.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: targetNetwork.chainId }],
                    });
                    // WC v1 might not trigger chainChanged immediately for all wallets.
                    // We'll rely on the 'chainChanged' listener to update the UI.
                    showModal(`Request sent to mobile wallet to switch to ${targetNetwork.name}. Please confirm in your wallet.`);
                } else if (currentWalletType === 'browser' && window.ethereum) {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: targetNetwork.chainId }],
                    });
                    // window.ethereum.on('chainChanged') will handle the UI update
                    showModal(`Request sent to browser wallet to switch to ${targetNetwork.name}. Please confirm in your wallet.`);
                } else {
                    showModal('No active wallet connection to switch networks.');
                }
            } catch (error) {
                console.error("Failed to switch network:", error);
                let errorMessage = `Failed to switch to ${targetNetwork.name}.`;
                if (error.code === 4902) { // Chain not added to wallet
                    errorMessage += " This network might not be added to your wallet. Attempting to add it...";
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: targetNetwork.chainId,
                                chainName: targetNetwork.name,
                                rpcUrls: [targetNetwork.rpc],
                                nativeCurrency: {
                                    name: targetNetwork.symbol,
                                    symbol: targetNetwork.symbol,
                                    decimals: 18
                                },
                                blockExplorerUrls: [targetNetwork.explorerUrl.replace('/address/', '')]
                            }]
                        });
                        showModal(`Attempted to add ${targetNetwork.name} to your wallet. Please try switching again.`);
                    } catch (addError) {
                        console.error("Failed to add network:", addError);
                        showModal(`Failed to add and switch network: ${addError.message || addError}`);
                    }
                } else if (error.code === 4001) { // User rejected request
                    errorMessage = "Network switch rejected by user.";
                } else if (error.message) {
                    errorMessage = error.message;
                }
                showModal(errorMessage);
            }
        });

        // --- Manual Connect Logic ---
        async function fetchBalance(networkId, address) {
            manualLoadingSpinner.classList.remove('hidden');
            fetchBalanceButton.disabled = true;
            manualConnectionInfo.classList.add('hidden');
            viewWalletButton.classList.add('hidden');
            manualLoadingSpinner.querySelector('p').textContent = 'Connecting...';

            const network = networks.find(n => n.id === networkId);
            if (!network) {
                showModal('Invalid network selected.');
                manualLoadingSpinner.classList.add('hidden');
                fetchBalanceButton.disabled = false;
                return;
            }

            manualNetworkDisplay.textContent = network.name;
            manualAddressDisplay.textContent = address;

            let balance = 'N/A';
            try {
                await sleep(5000); // Simulated delay
                manualLoadingSpinner.querySelector('p').textContent = 'Fetching balance...';

                if (network.type === 'evm') {
                    if (!network.rpc) {
                         showModal(`RPC Not Configured for this EVM network.`);
                         balance = 'RPC Not Configured';
                    } else {
                        const web3 = new Web3(new Web3.providers.HttpProvider(network.rpc));
                        if (!web3.utils.isAddress(address)) {
                            throw new Error("Invalid Ethereum address format.");
                        }
                        const weiBalance = await web3.eth.getBalance(address);
                        balance = web3.utils.fromWei(weiBalance, 'ether') + ` ${network.symbol}`;
                    }
                } else { // Handle non-EVM chains
                    switch (network.id) {
                        case 'btc':
                            const btcResponse = await fetch(`${network.api}${address}/balance`);
                            if (!btcResponse.ok) throw new Error(`BTC API error: ${btcResponse.statusText}`);
                            const btcData = await btcResponse.json();
                            balance = (btcData.balance / 10**8).toFixed(8) + ' BTC';
                            break;
                        case 'tron':
                            const tronResponse = await fetch(`${network.api}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ account: address })
                            });
                            if (!tronResponse.ok) throw new Error(`TRON API error: ${tronResponse.statusText}`);
                            const tronData = await tronResponse.json();
                            if (tronData && tronData.data && tronData.data.length > 0) {
                                balance = (tronData.data[0].balance / 10**6).toFixed(6) + ' TRX';
                            } else {
                                balance = '0 TRX';
                            }
                            break;
                        case 'solana':
                            const solResponse = await fetch(network.rpc, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    jsonrpc: '2.0',
                                    id: 1,
                                    method: 'getBalance',
                                    params: [address]
                                })
                            });
                            if (!solResponse.ok) throw new Error(`SOL API error: ${solResponse.statusText}`);
                            const solData = await solResponse.json();
                            if (solData.result && solData.result.value !== undefined) {
                                balance = (solData.result.value / 10**9).toFixed(9) + ' SOL';
                            } else {
                                balance = '0 SOL';
                            }
                            break;
                        default:
                            balance = 'Balance fetching for this network requires specific APIs/SDKs or is not implemented.';
                            break;
                    }
                }

                if (balance !== 'Error' && balance !== 'N/A' && !balance.includes('RPC Not Configured') && !balance.includes('not implemented')) {
                    // Confirmation for Manual Connect
                    showModal(`Successfully fetched balance for: ${address} on ${network.name}. Balance: ${balance}`);
                    if (network.explorerUrl) {
                        viewWalletButton.onclick = () => window.open(`${network.explorerUrl}${address}`, '_blank');
                        viewWalletButton.classList.remove('hidden');
                    }
                }

            } catch (error) {
                console.error(`Error connecting to wallet and fetching balance for ${network.name}:`, error);
                showModal(`Error connecting to wallet and fetching balance for ${network.name}: ${error.message || error}.`);
                balance = 'Error';
            } finally {
                manualBalanceDisplay.textContent = balance;
                manualConnectionInfo.classList.remove('hidden');
                manualLoadingSpinner.classList.add('hidden');
                fetchBalanceButton.disabled = false;
            }
        }

        function resetManualConnectUI() {
            networkSelect.value = '';
            walletAddressInput.value = '';
            addressInputContainer.classList.add('hidden');
            fetchBalanceButton.classList.add('hidden');
            manualConnectionInfo.classList.add('hidden');
            viewWalletButton.classList.add('hidden');
            manualConnectNote.classList.add('hidden'); // Ensure the note is hidden when resetting
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Function to populate networks (moved inside DOMContentLoaded)
            function populateNetworks() {
                networkSelect.innerHTML = '<option value="">Select a Network</option>';
                networks.forEach(network => {
                    const option = document.createElement('option');
                    option.value = network.id;
                    option.textContent = network.name;
                    networkSelect.appendChild(option);
                });
            }

            populateNetworks(); // Call it here
            showSection('mobile'); // Show Mobile Wallet section by default
        });

        // Toggle buttons
        showMobileConnectBtn.addEventListener('click', () => showSection('mobile'));
        showBrowserConnectBtn.addEventListener('click', () => showSection('browser'));
        showManualConnectBtn.addEventListener('click', () => showSection('manual'));

        // Mobile Connect buttons
        connectMobileButton.addEventListener('click', connectMobileWallet);
        disconnectMobileButton.addEventListener('click', disconnectMobileWallet);
        switchNetworkMobileButton.addEventListener('click', () => showNetworkSwitchModal('mobile')); // Open modal for mobile

        // Browser Connect buttons
        connectBrowserButton.addEventListener('click', connectBrowserWallet);
        disconnectBrowserButton.addEventListener('click', disconnectBrowserWallet);
        switchNetworkBrowserButton.addEventListener('click', () => showNetworkSwitchModal('browser')); // Open modal for browser

        // Manual Connect actions
        networkSelect.addEventListener('change', () => {
            manualConnectionInfo.classList.add('hidden');
            viewWalletButton.classList.add('hidden');
            walletAddressInput.value = '';
            if (networkSelect.value) {
                addressInputContainer.classList.remove('hidden');
                fetchBalanceButton.classList.remove('hidden');
            } else {
                addressInputContainer.classList.add('hidden');
                fetchBalanceButton.classList.add('hidden');
            }
        });

        fetchBalanceButton.addEventListener('click', () => {
            const selectedNetworkId = networkSelect.value;
            const address = walletAddressInput.value.trim();
            fetchBalance(selectedNetworkId, address);
        });
    </script>
</body>
</html>